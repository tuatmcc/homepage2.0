<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ab44ce7add5c3d11.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ab44ce7add5c3d11.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-98c07406be76c29a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3ca45b765aac540b.js" defer=""></script><script src="/_next/static/chunks/675-8610370ef62a12c1.js" defer=""></script><script src="/_next/static/chunks/pages/works/discord-tutorial-db0ac58eef6403be.js" defer=""></script><script src="/_next/static/h8-bTrQL8qjQ6nqI4VB7y/_buildManifest.js" defer=""></script><script src="/_next/static/h8-bTrQL8qjQ6nqI4VB7y/_ssgManifest.js" defer=""></script></head><body><div id="__next"><p>こんにちは。B3 の Arc です。2022 年 2 月 18 日に部内で Discord Bot の開発チュートリアルを行いました。当時の資料を元に加筆・修正を加えた物を公開してみます。</p>
<h1>近頃の Discord Bot 界隈</h1>
<p>最初に、近頃の Discord Bot 開発者界隈を取り巻く状況について軽く触れておきます。</p>
<h2>むかし</h2>
<p>昔は Bot 開発用の 2 大ライブラリとして、Python 用の<a href="https://discordpy.readthedocs.io/en/latest/">discord.py</a>と Node.js 用の<a href="https://discord.js.org/">discord.js</a>がありました。</p>
<h2>2021 年 8 月 28 日</h2>
<p>この日に discord.py の開発終了が<a href="https://gist.github.com/Rapptz/4a2f62751b9600a31a0d3c78100287f1">アナウンスされました</a>。Discord 公式とのトラブルがあったようです(詳しくはググってね)。後述しますが、<em>現在は開発が再開されたようです。</em></p>
<p>これにより、Discord 公式の REST API の仕様変更などに対応できなくなった discord.py 製 bot は死ぬ運命となりました(結果的にそうならなかったけど)。また、discord.py の後継を名乗るプロジェクトが林立する事態となりました。</p>
<p>Python 界隈がこの有様(だった)ので、このチュートリアルでは discord.js を使っていきます。</p>
<h2>2022 年 3 月 6 日</h2>
<p>……と思っていたら 3 月 6 日に discord.py の開発<strong>再開</strong>が<a href="https://gist.github.com/Rapptz/c4324f17a80c94776832430007ad40e6">アナウンスされました</a>。 ~~何が何だか分からん~~ 再び 2 大ライブラリ時代に戻るんじゃないかなと思っています。たぶん……</p>
<h1>環境構築・初期設定</h1>
<p>この章では、Discord Bot を作るための環境構築・初期設定を行います。</p>
<h2>用語集</h2>
<p>初めに、基本的な用語について説明しておきます。</p>
<ul>
<li>Node.js</li>
<li>サーバーサイド JavaScript 環境(ブラウザではなくサーバー上で JS を動かすための環境)の一種です。Discord Bot は Node.js 上で動きます。</li>
<li>パッケージマネージャとして<code>npm</code>という物を使います。</li>
<li>最新の discord.js(v13)を使うためには、Node v16.6.0 以降が必要です。</li>
<li><a href="https://nodejs.org/ja/">公式サイト</a></li>
<li>TypeScript</li>
<li>JavaScript を静的型付けライクに拡張した言語です。静的型付け最高！</li>
<li>TypeScript は直接実行することができないため、基本的には<code>tsc</code>というコンパイラで JavaScript に変換してから実行します。</li>
<li>文法は C や Java などに近い感じです。</li>
<li><a href="https://www.typescriptlang.org/">公式サイト</a></li>
</ul>
<h2>Node.js のインストール</h2>
<p><a href="https://nodejs.org/ja/download/">ダウンロードページ</a>から、Node.js の LTS 版をダウンロード・インストールしてください。</p>
<p>ターミナルで<code>node --version</code>を実行した際、<code>v16.14.0</code>のように表示されていればインストール成功です。</p>
<h2>プロジェクトディレクトリの作成</h2>
<p>適当な名前のディレクトリを作ってください。</p>
<p>次に、ターミナルでディレクトリに移動し、<code>npm init</code>を実行してください。色々聞かれますが、とりあえず全て Enter を押せばいいです。</p>
<p><code>package.json</code>が作成されていることを確認してください。</p>
<h2>パッケージのインストール</h2>
<p>開発に必要なパッケージをインストールします。次のコマンドを実行してください。</p>
<pre><code class="language-bash">npm install --save discord.js dotenv typescript @types/node@16 ts-node tsconfig-paths
</code></pre>
<h2>TypeScript の設定</h2>
<p><code>npx tsc --init</code>を実行してください。<code>tsconfig.json</code>が生成されれば成功です。</p>
<p><code>tsconfig.json</code>には、TypeScript のコンパイラ(TSC)の設定情報が含まれています。</p>
<p><code>tsconfig.json</code>には設定項目が大量にありますが、中身については省略します。<code>baseUrl</code>の項目だけ次のように変えてください。</p>
<pre><code class="language-jsonc">{
  // ...
  &quot;baseUrl&quot;: &quot;./src&quot;
  // ...
}
</code></pre>
<h2>スクリプトの設定</h2>
<p><code>package.json</code>の<code>&quot;scripts&quot;</code>の箇所を次のように編集してください。</p>
<pre><code class="language-jsonc">{
  // ...
  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;ts-node --files -r tsconfig-paths/register src/index.ts&quot;
  }
  // ...
}
</code></pre>
<p>これにより、<code>npm start</code>で<code>npx ts-node --files -r tsconfig-paths/register src/index.ts</code>を実行できるようになりました。</p>
<p><code>ts-node</code>は、<code>.ts</code>ファイルを事前コンパイル無しで直接実行するためのパッケージです(正確には JIT コンパイルしているようです)。TypeScript のコードを走らせるには「tsc でコンパイル」→「Node で js を実行」 の 2 ステップを要していましたが、<code>ts-node</code>を使うことで 1 ステップに抑えることができます。</p>
<p>いろいろ引数がついていますが、ここでは説明を省略します。気になる方は<code>tsconfig-paths</code>などで検索してください。</p>
<h2>Hello World</h2>
<p><code>src</code>ディレクトリを作成し、その中に<code>index.ts</code>を作成してください。</p>
<p>そして、次のコードをコピペしてください。</p>
<pre><code class="language-typescript">console.log(&#x27;Hello World!&#x27;)
</code></pre>
<p>最後に、プロジェクトルートに居る状態で<code>npm start</code>を実行してください。<code>Hello World!</code>と表示されれば成功です！</p>
<h1>Bot の登録・ログイン</h1>
<p>この章では、Discord Bot をサーバーに追加した後、Bot をサーバーにログインさせます。</p>
<p>概ね<a href="https://guide.discordjs-japan.org/">Discord.js Guide</a> v12 版に沿っていますが、現行の v13 に合わせて記述を変更している箇所もあります。</p>
<h2>Bot をサーバーに追加する</h2>
<p>Bot をサーバーに追加していきます。最初にテスト用のサーバーを立てておいてください。</p>
<h3>Bot の登録</h3>
<p>まずは Bot を Discord に登録します。</p>
<ol>
<li>Discord にログインした状態で、Discord Developer Portal の<a href="https://discord.com/developers/applications/">Application</a>ページに移動してください。</li>
<li>右上の<code>New Application</code>をクリックして、いい感じの名前をつけて<code>Create</code>してください。</li>
</ol>
<img alt="image" src="/works/discord-tutorial/create_app.png" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"/>
<ol start="3">
<li>左のメニューから<code>Bot</code>をクリックして、<code>Add Bot -&gt; Yes, do it!</code>をクリックしてください。<code>A wild bot has appeared!</code>みたいなメッセージが表示されれば OK です。</li>
</ol>
<img alt="image" src="/works/discord-tutorial/add_bot.png" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"/>
<h3>Bot をサーバーに招待</h3>
<p>次に、Bot をサーバーに招待します。</p>
<ol>
<li>左メニューから<code>OAuth2 -&gt; URL Generator</code>を開いてください。</li>
<li><code>SCOPES</code>の中の<code>bot</code>, <code>applications.commands</code>にチェックを入れてください。</li>
<li><code>BOT PERMISSIONS</code>の中の<code>Send Messages</code>にチェックを入れてください。これにより、Bot にメッセージ送信権限が付与されます。他の権限が必要な場合は適宜チェックを増やしてください。</li>
</ol>
<p><img src="/works/discord-tutorial/permission.png" alt="img"/></p>
<ol start="4">
<li>下の方にある<code>Generated URL</code>をコピーして、Web ブラウザに貼り付けてください。事前に作成したサーバーを選択して、「はい」などのボタンを押してください。</li>
<li>Discord クライアント上で、サーバーに Bot が追加されたことを確認してください。</li>
</ol>
<h2>Bot をサーバーにログインさせる</h2>
<h3>環境変数と dotenv</h3>
<p>これから Bot をサーバーにログインさせますが、その前に環境変数について説明しておきます。</p>
<p>Bot をログインさせる際には「トークン」という値が必要になります。この値が外部に流出した場合、他の人が Bot をサーバーにログインさせて、スパムメッセージを送信するなどの悪事を働くことができてしまいます。このため、トークンはソースコードに<strong>埋め込まずに</strong>管理する必要があります(トークンを埋め込んだソースコードを Git に Push したら外部流出したことになります)。</p>
<p>このような機密情報は、実行環境の<strong>環境変数</strong>に設定して、ソースコードから環境変数を読み込む必要があります。しかし、環境変数を設定するのは割とだるいです。</p>
<p>Node では、実行時に<code>.env</code>というファイルから環境変数を読み込んで設定する<code>dotenv</code>というモジュールがあります。実はこのモジュールは前章でインストールしていました。<code>.env</code>ファイルを<code>.gitignore</code>に設定することで、機密情報を安全に、便利に扱うことができます。</p>
<p>トークンを<code>.env</code>ファイルに保存しておきましょう。<code>.env</code>をルートディレクトリに作成して、次の内容を書き込んでください。</p>
<pre><code>TOKEN=&lt;Botのトークン&gt;
</code></pre>
<p><code>&lt;Botのトークン&gt;</code>の箇所を実際の値で置き換えてください。Bot のトークンは次のようにして得ることができます。</p>
<ol>
<li>Developer Portal から前節で作成したアプリケーションを選択し、左メニューの<code>Bot</code>を選択します。</li>
<li><code>TOKEN</code>という所に<code>Copy</code>ボタンがあるのでクリックしてください。トークンがクリップボードにコピーされます。</li>
</ol>
<h3>ログイン処理の実装</h3>
<p>Bot をサーバーにログインさせる処理を書いていきます。</p>
<pre><code class="language-typescript">// 1: インポート
import * as dotenv from &#x27;dotenv&#x27;
import { Client, ClientOptions } from &#x27;discord.js&#x27;

// 2: .envを読み込み、環境変数に登録
dotenv.config()

// 3: クライアントを初期化
const clientOptions: ClientOptions = {
  intents: [&#x27;GUILD_MESSAGES&#x27;, &#x27;GUILDS&#x27;],
}
const client = new Client(clientOptions)

// 4: ログイン完了時に実行するコールバック関数を登録
client.once(&#x27;ready&#x27;, () =&gt; {
  console.log(&quot;I&#x27;m  ready!&quot;)
})

// 5: ログイン
client.login(process.env.TOKEN)
</code></pre>
<p>コードの中身を説明していきます。</p>
<h4>インポート</h4>
<p>使用するクラスなどをインポートします。</p>
<h4>.env を読み込み、環境変数に登録</h4>
<p><code>.env</code>を読み込んで、環境変数に登録します。環境変数へは<code>process.env.&lt;変数名&gt;</code>でアクセスすることができます。</p>
<h4>クライアントを初期化</h4>
<ul>
<li><code>v12</code>以前と異なり、現行の<code>v13</code>では<code>ClientOptions</code>が必須になっています。</li>
<li><code>ClientOptions</code>の<code>intents</code>で、どのイベントを Bot が受信するかを制御します。ここでは上記 2 つを指定しておけば良いでしょう。</li>
<li>最後にクライアントのインスタンスを作成します。</li>
</ul>
<h4>ログイン完了時に実行するコールバック関数を登録</h4>
<ul>
<li>ログイン完了時に<code>ready</code>イベントが発火されます。その時に実行する関数(コールバック関数)を登録しておきます。</li>
<li><code>()=&gt;{...}</code>という表記は、JS・TS 特有の「アロー関数」という物です。(詳しくはググってね)</li>
</ul>
<h4>ログイン</h4>
<ul>
<li>環境変数<code>TOKEN</code>の値を引数にしてログインします。</li>
</ul>
<h3>実行してみる</h3>
<p>ここまで書けたら実際に実行してみましょう。</p>
<p><code>npm start</code>を実行して数秒待ってください。次のことが確認できれば成功です！</p>
<ul>
<li>コンソールに<code>I&#x27;m ready!</code>と表示される。</li>
<li>Discord アプリ上で、登録した Bot がオンラインになっている。</li>
</ul>
<p>確認できたら、Ctrl+C などで Bot を止めておいてください。</p>
<h1>スラッシュコマンド</h1>
<p>この章では、スラッシュコマンドの実装を行います。</p>
<p>この記事を参考にしています: <a href="https://qiita.com/gaato/items/55b32bc4777905ac162a">discord.js でスラッシュコマンド（Slash commands）を使う - Qiita</a></p>
<h2>2 種類のスラッシュコマンド</h2>
<p>スラッシュコマンドには「ギルドコマンド」と「グローバルコマンド」の 2 種類があります。</p>
<ul>
<li>ギルドコマンド: 特定のサーバーを指定して登録するコマンド。</li>
<li>グローバルコマンド: Bot が参加している全てのサーバーに登録されるコマンド。</li>
</ul>
<p>グローバルコマンドは、登録後実際に使えるようになるまで 1 時間ほどかかるようです。このため、本チュートリアルではギルドコマンドを使用します。</p>
<h2>環境変数の設定</h2>
<p>ギルドコマンドを登録するためには、対象サーバーの ID が必要です。<code>.env</code>に保存しておきます。</p>
<p>サーバー ID は次の方法で取得することができます。</p>
<ol>
<li>Discord アプリの設定画面を開き、「詳細設定」の「開発者モード」をオンにしておきます。</li>
</ol>
<img alt="" src="/works/discord-tutorial/devmode.png" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"/>
<ol>
<li>サーバーアイコン上で右クリックして、「ID をコピー」を選択します。サーバー ID がクリップボードにコピーされます。</li>
</ol>
<img alt="" src="/works/discord-tutorial/copy_server_id.png" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"/>
<p><code>.env</code>に次の項目を追記してください。<code>&lt;サーバーID&gt;</code>は実際の値に置き換えてください。</p>
<pre><code>SERVER_ID=&lt;サーバーID&gt;
</code></pre>
<h2>シンプルなコマンド</h2>
<p>まず、<code>pong</code>というメッセージを送信するだけのシンプルなコマンド<code>/ping</code>を作成してみます。</p>
<h3>環境変数の型定義を記述する</h3>
<p>環境変数の型定義ファイルを作っておかないと後々面倒なので、ここで作ってしまいます。</p>
<p><code>src</code>に<code>@types</code>ディレクトリを作成して、中に<code>global.d.ts</code>を作り、以下の内容を入力してください。</p>
<pre><code class="language-typescript">declare namespace NodeJS {
  interface ProcessEnv {
    readonly TOKEN: string
    readonly SERVER_ID: string
  }
}
</code></pre>
<h3>コマンドを実装する</h3>
<p>実際にコマンドを作っていきます。次のコードを参考にして、<code>ready</code>イベントのコールバックを編集し、<code>interactionCreate</code>イベントのコールバックを追加してください。<code>async</code>キーワードが新しく加わっていることに注意してください。</p>
<pre><code class="language-typescript">import { ApplicationCommandData, Client, ClientOptions } from &#x27;discord.js&#x27; // インポート部分が変わっています

// ...

// ログイン完了時に実行するコールバック関数を登録
client.once(&#x27;ready&#x27;, async () =&gt; {
  const commands: ApplicationCommandData[] = [
    {
      name: &#x27;ping&#x27;,
      description: &#x27;pongと返します。&#x27;,
    },
  ]
  await client.application?.commands.set(commands, process.env.SERVER_ID)

  console.log(&quot;I&#x27;m  ready!&quot;)
})

// コマンド受信時のコールバック関数を登録
client.on(&#x27;interactionCreate&#x27;, async (interaction) =&gt; {
  if (!interaction.isCommand()) {
    return
  }
  if (interaction.commandName === &#x27;ping&#x27;) {
    // pingコマンドが来たら:
    await interaction.reply(&#x27;pong&#x27;) // pongとreplyする
  }
})
</code></pre>
<p>書けたら<code>npm start</code>して、アプリ上でコマンドを使えるかどうか確認してみましょう。</p>
<h2>引数付きコマンド</h2>
<p>引数を受け取るコマンドを作っていきます。ここでは、引数をそのまま出力する<code>echo</code>コマンドを作っていきます。</p>
<h3>コマンドの登録</h3>
<p>次のコードを参考にして、<code>commands</code>に要素を追加してください。引数は<code>options</code>プロパティで設定します。</p>
<pre><code class="language-typescript">const commands: ApplicationCommandData[] = [
  {
    name: &#x27;ping&#x27;,
    description: &#x27;pongと返します。&#x27;,
  },
  {
    name: &#x27;echo&#x27;,
    description: &#x27;入力された文字をそのまま返します。&#x27;,
    options: [
      {
        type: &#x27;STRING&#x27;,
        name: &#x27;value&#x27;,
        description: &#x27;文字列&#x27;,
        required: true,
      },
    ],
  },
]
</code></pre>
<h3>コマンドの中身を実装</h3>
<p>次のコードを参考にして、コマンドの中身を実装してください。引数は<code>interaction.options.getString()</code>などで受け取ることができます。</p>
<pre><code class="language-typescript">if (interaction.commandName === &#x27;ping&#x27;) {
  await interaction.reply(&#x27;pong&#x27;)
}
if (interaction.commandName === &#x27;echo&#x27;) {
  const value = interaction.options.getString(&#x27;value&#x27;, true) // 引数valueを受け取る
  await interaction.reply(value)
}
</code></pre>
<p>書けたら<code>npm start</code>して、アプリ上でコマンドを使えるかどうか確認してみましょう。</p>
<h2>遅延応答</h2>
<p>「コマンドを受信したら、データベースにアクセスして処理をした後に返信したい」といったケースなど、時間のかかる処理を実装したくなることがあると思います。このような処理をそのまま書いたらどうなるでしょうか？</p>
<p><code>ping</code>コマンドを次のように編集してみます。ここでは 4000 ミリ秒後に&quot;pong&quot;と返信するコードを書いています。</p>
<pre><code class="language-typescript">if (interaction.commandName === &#x27;ping&#x27;) {
  setTimeout(async () =&gt; {
    await interaction.reply(&#x27;pong&#x27;)
  }, 4000) // 4000ミリ秒後に&quot;pong&quot;と返信
}
</code></pre>
<p><code>ping</code>コマンドを実際に実行してみましょう。すると、<code>アプリケーションが応答しませんでした</code>などのメッセージが表示されると思います。</p>
<p>実は、スラッシュコマンドは<strong>3 秒以内に返信しないとエラー</strong>になります。</p>
<p>これを回避するため、<code>deferReply()</code>, <code>followUp()</code>という関数を使います。</p>
<pre><code class="language-typescript">if (interaction.commandName === &#x27;ping&#x27;) {
  await interaction.deferReply() // 追加
  setTimeout(async () =&gt; {
    await interaction.followUp(&#x27;pong&#x27;) // 変更
  }, 4000) // 4000ミリ秒後に&quot;pong&quot;と返信
}
</code></pre>
<p>このコードにした上で<code>ping</code>コマンドを実行すると、<code>&lt;bot名&gt;が考え中…</code>というメッセージが表示された 4 秒後に<code>pong</code>と表示されるはずです。意図通りの挙動になりました。</p>
<p>ということで、時間のかかる処理を行う時には、返信を遅延させるために<code>deferReply()</code>や<code>followUp()</code>を使う必要があります。</p>
<p>詳しくはこのページが参考になります: <a href="https://scrapbox.io/discordjs-japan/reply%E3%81%A8deferReply%E3%81%AE%E9%81%95%E3%81%84">reply と deferReply の違い - Discord.js Japan User Group</a></p>
<h1>分からないことがあったら</h1>
<p>分からないことがある時は次のサイトが頼りになります。</p>
<ul>
<li><a href="https://discordjs.guide/#before-you-begin">Discord.js Guide</a></li>
<li><a href="https://discord.js.org/#/docs/discord.js/stable/general/welcome">discord.js Documentation</a></li>
<li><a href="https://scrapbox.io/discordjs-japan/">Discord.js Japan User Group (Scrapbox)</a></li>
<li>日本語 Wiki。やりたいことをここで検索すれば大体出てくる説があります。</li>
</ul>
<h1>おわり</h1>
<p>スラッシュコマンドに対応した Discord Bot を作りました。後はいろいろ工夫して頑張ってください(雑)。</p></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/works/discord-tutorial","query":{},"buildId":"h8-bTrQL8qjQ6nqI4VB7y","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>