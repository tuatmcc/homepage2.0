<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ab44ce7add5c3d11.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ab44ce7add5c3d11.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-98c07406be76c29a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3ca45b765aac540b.js" defer=""></script><script src="/_next/static/chunks/pages/works-81aaafc0c28f634f.js" defer=""></script><script src="/_next/static/ncCN_pq-iEY_H9wmG8Ec0/_buildManifest.js" defer=""></script><script src="/_next/static/ncCN_pq-iEY_H9wmG8Ec0/_ssgManifest.js" defer=""></script></head><body><div id="__next"><ul><li><h3><a href="/works/bunai">bunai.mdx</a></h3></li><li><h3><a href="/works/discord-tutorial">discord-tutorial.mdx</a></h3></li></ul></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"posts":[{"filePath":"/works/bunai","filename":"bunai.mdx","content":"export const meta = {\r\n  title: '部室入室管理システム',\r\n  // description:\r\n  // img: first-blog-post.jpg\r\n  // category: dev\r\n}\r\n\r\n# 部室入室管理システム\r\n\r\n## どういうシステム？\r\n\r\n部室入室管理システムについて\r\n"},{"filePath":"/works/discord-tutorial","filename":"discord-tutorial.mdx","content":"export const meta = {\r\n  title: 'Discord Bot チュートリアル',\r\n  // description:\r\n  // img: 'first-blog-post.jpg'\r\n  // category: 'dev'\r\n}\r\n\r\nimport Image from 'next/image'\r\n\r\nこんにちは。B3 の Arc です。2022 年 2 月 18 日に部内で Discord Bot の開発チュートリアルを行いました。当時の資料を元に加筆・修正を加えた物を公開してみます。\r\n\r\n# 近頃の Discord Bot 界隈\r\n\r\n最初に、近頃の Discord Bot 開発者界隈を取り巻く状況について軽く触れておきます。\r\n\r\n## むかし\r\n\r\n昔は Bot 開発用の 2 大ライブラリとして、Python 用の[discord.py](https://discordpy.readthedocs.io/en/latest/)と Node.js 用の[discord.js](https://discord.js.org/)がありました。\r\n\r\n## 2021 年 8 月 28 日\r\n\r\nこの日に discord.py の開発終了が[アナウンスされました](https://gist.github.com/Rapptz/4a2f62751b9600a31a0d3c78100287f1)。Discord 公式とのトラブルがあったようです(詳しくはググってね)。後述しますが、_現在は開発が再開されたようです。_\r\n\r\nこれにより、Discord 公式の REST API の仕様変更などに対応できなくなった discord.py 製 bot は死ぬ運命となりました(結果的にそうならなかったけど)。また、discord.py の後継を名乗るプロジェクトが林立する事態となりました。\r\n\r\nPython 界隈がこの有様(だった)ので、このチュートリアルでは discord.js を使っていきます。\r\n\r\n## 2022 年 3 月 6 日\r\n\r\n……と思っていたら 3 月 6 日に discord.py の開発**再開**が[アナウンスされました](https://gist.github.com/Rapptz/c4324f17a80c94776832430007ad40e6)。 ~~何が何だか分からん~~ 再び 2 大ライブラリ時代に戻るんじゃないかなと思っています。たぶん……\r\n\r\n# 環境構築・初期設定\r\n\r\nこの章では、Discord Bot を作るための環境構築・初期設定を行います。\r\n\r\n## 用語集\r\n\r\n初めに、基本的な用語について説明しておきます。\r\n\r\n- Node.js\r\n- サーバーサイド JavaScript 環境(ブラウザではなくサーバー上で JS を動かすための環境)の一種です。Discord Bot は Node.js 上で動きます。\r\n- パッケージマネージャとして`npm`という物を使います。\r\n- 最新の discord.js(v13)を使うためには、Node v16.6.0 以降が必要です。\r\n- [公式サイト](https://nodejs.org/ja/)\r\n- TypeScript\r\n- JavaScript を静的型付けライクに拡張した言語です。静的型付け最高！\r\n- TypeScript は直接実行することができないため、基本的には`tsc`というコンパイラで JavaScript に変換してから実行します。\r\n- 文法は C や Java などに近い感じです。\r\n- [公式サイト](https://www.typescriptlang.org/)\r\n\r\n## Node.js のインストール\r\n\r\n[ダウンロードページ](https://nodejs.org/ja/download/)から、Node.js の LTS 版をダウンロード・インストールしてください。\r\n\r\nターミナルで`node --version`を実行した際、`v16.14.0`のように表示されていればインストール成功です。\r\n\r\n## プロジェクトディレクトリの作成\r\n\r\n適当な名前のディレクトリを作ってください。\r\n\r\n次に、ターミナルでディレクトリに移動し、`npm init`を実行してください。色々聞かれますが、とりあえず全て Enter を押せばいいです。\r\n\r\n`package.json`が作成されていることを確認してください。\r\n\r\n## パッケージのインストール\r\n\r\n開発に必要なパッケージをインストールします。次のコマンドを実行してください。\r\n\r\n```bash\r\nnpm install --save discord.js dotenv typescript @types/node@16 ts-node tsconfig-paths\r\n```\r\n\r\n## TypeScript の設定\r\n\r\n`npx tsc --init`を実行してください。`tsconfig.json`が生成されれば成功です。\r\n\r\n`tsconfig.json`には、TypeScript のコンパイラ(TSC)の設定情報が含まれています。\r\n\r\n`tsconfig.json`には設定項目が大量にありますが、中身については省略します。`baseUrl`の項目だけ次のように変えてください。\r\n\r\n```jsonc\r\n{\r\n  // ...\r\n  \"baseUrl\": \"./src\"\r\n  // ...\r\n}\r\n```\r\n\r\n## スクリプトの設定\r\n\r\n`package.json`の`\"scripts\"`の箇所を次のように編集してください。\r\n\r\n```jsonc\r\n{\r\n  // ...\r\n  \"scripts\": {\r\n    \"start\": \"ts-node --files -r tsconfig-paths/register src/index.ts\"\r\n  }\r\n  // ...\r\n}\r\n```\r\n\r\nこれにより、`npm start`で`npx ts-node --files -r tsconfig-paths/register src/index.ts`を実行できるようになりました。\r\n\r\n`ts-node`は、`.ts`ファイルを事前コンパイル無しで直接実行するためのパッケージです(正確には JIT コンパイルしているようです)。TypeScript のコードを走らせるには「tsc でコンパイル」→「Node で js を実行」 の 2 ステップを要していましたが、`ts-node`を使うことで 1 ステップに抑えることができます。\r\n\r\nいろいろ引数がついていますが、ここでは説明を省略します。気になる方は`tsconfig-paths`などで検索してください。\r\n\r\n## Hello World\r\n\r\n`src`ディレクトリを作成し、その中に`index.ts`を作成してください。\r\n\r\nそして、次のコードをコピペしてください。\r\n\r\n```typescript\r\nconsole.log('Hello World!')\r\n```\r\n\r\n最後に、プロジェクトルートに居る状態で`npm start`を実行してください。`Hello World!`と表示されれば成功です！\r\n\r\n# Bot の登録・ログイン\r\n\r\nこの章では、Discord Bot をサーバーに追加した後、Bot をサーバーにログインさせます。\r\n\r\n概ね[Discord.js Guide](https://guide.discordjs-japan.org/) v12 版に沿っていますが、現行の v13 に合わせて記述を変更している箇所もあります。\r\n\r\n## Bot をサーバーに追加する\r\n\r\nBot をサーバーに追加していきます。最初にテスト用のサーバーを立てておいてください。\r\n\r\n### Bot の登録\r\n\r\nまずは Bot を Discord に登録します。\r\n\r\n1. Discord にログインした状態で、Discord Developer Portal の[Application](https://discord.com/developers/applications/)ページに移動してください。\r\n2. 右上の`New Application`をクリックして、いい感じの名前をつけて`Create`してください。\r\n\r\n\u003cImage alt={'image'} src='/works/discord-tutorial/create_app.png' /\u003e\r\n\r\n3. 左のメニューから`Bot`をクリックして、`Add Bot -\u003e Yes, do it!`をクリックしてください。`A wild bot has appeared!`みたいなメッセージが表示されれば OK です。\r\n\r\n\u003cImage alt={'image'} src='/works/discord-tutorial/add_bot.png' /\u003e\r\n\r\n### Bot をサーバーに招待\r\n\r\n次に、Bot をサーバーに招待します。\r\n\r\n1. 左メニューから`OAuth2 -\u003e URL Generator`を開いてください。\r\n2. `SCOPES`の中の`bot`, `applications.commands`にチェックを入れてください。\r\n3. `BOT PERMISSIONS`の中の`Send Messages`にチェックを入れてください。これにより、Bot にメッセージ送信権限が付与されます。他の権限が必要な場合は適宜チェックを増やしてください。\r\n\r\n![img](/works/discord-tutorial/permission.png)\r\n\r\n4. 下の方にある`Generated URL`をコピーして、Web ブラウザに貼り付けてください。事前に作成したサーバーを選択して、「はい」などのボタンを押してください。\r\n5. Discord クライアント上で、サーバーに Bot が追加されたことを確認してください。\r\n\r\n## Bot をサーバーにログインさせる\r\n\r\n### 環境変数と dotenv\r\n\r\nこれから Bot をサーバーにログインさせますが、その前に環境変数について説明しておきます。\r\n\r\nBot をログインさせる際には「トークン」という値が必要になります。この値が外部に流出した場合、他の人が Bot をサーバーにログインさせて、スパムメッセージを送信するなどの悪事を働くことができてしまいます。このため、トークンはソースコードに**埋め込まずに**管理する必要があります(トークンを埋め込んだソースコードを Git に Push したら外部流出したことになります)。\r\n\r\nこのような機密情報は、実行環境の**環境変数**に設定して、ソースコードから環境変数を読み込む必要があります。しかし、環境変数を設定するのは割とだるいです。\r\n\r\nNode では、実行時に`.env`というファイルから環境変数を読み込んで設定する`dotenv`というモジュールがあります。実はこのモジュールは前章でインストールしていました。`.env`ファイルを`.gitignore`に設定することで、機密情報を安全に、便利に扱うことができます。\r\n\r\nトークンを`.env`ファイルに保存しておきましょう。`.env`をルートディレクトリに作成して、次の内容を書き込んでください。\r\n\r\n```\r\nTOKEN=\u003cBotのトークン\u003e\r\n```\r\n\r\n`\u003cBotのトークン\u003e`の箇所を実際の値で置き換えてください。Bot のトークンは次のようにして得ることができます。\r\n\r\n1. Developer Portal から前節で作成したアプリケーションを選択し、左メニューの`Bot`を選択します。\r\n2. `TOKEN`という所に`Copy`ボタンがあるのでクリックしてください。トークンがクリップボードにコピーされます。\r\n\r\n### ログイン処理の実装\r\n\r\nBot をサーバーにログインさせる処理を書いていきます。\r\n\r\n```typescript\r\n// 1: インポート\r\nimport * as dotenv from 'dotenv'\r\nimport { Client, ClientOptions } from 'discord.js'\r\n\r\n// 2: .envを読み込み、環境変数に登録\r\ndotenv.config()\r\n\r\n// 3: クライアントを初期化\r\nconst clientOptions: ClientOptions = {\r\n  intents: ['GUILD_MESSAGES', 'GUILDS'],\r\n}\r\nconst client = new Client(clientOptions)\r\n\r\n// 4: ログイン完了時に実行するコールバック関数を登録\r\nclient.once('ready', () =\u003e {\r\n  console.log(\"I'm  ready!\")\r\n})\r\n\r\n// 5: ログイン\r\nclient.login(process.env.TOKEN)\r\n```\r\n\r\nコードの中身を説明していきます。\r\n\r\n#### インポート\r\n\r\n使用するクラスなどをインポートします。\r\n\r\n#### .env を読み込み、環境変数に登録\r\n\r\n`.env`を読み込んで、環境変数に登録します。環境変数へは`process.env.\u003c変数名\u003e`でアクセスすることができます。\r\n\r\n#### クライアントを初期化\r\n\r\n- `v12`以前と異なり、現行の`v13`では`ClientOptions`が必須になっています。\r\n- `ClientOptions`の`intents`で、どのイベントを Bot が受信するかを制御します。ここでは上記 2 つを指定しておけば良いでしょう。\r\n- 最後にクライアントのインスタンスを作成します。\r\n\r\n#### ログイン完了時に実行するコールバック関数を登録\r\n\r\n- ログイン完了時に`ready`イベントが発火されます。その時に実行する関数(コールバック関数)を登録しておきます。\r\n- `()=\u003e{...}`という表記は、JS・TS 特有の「アロー関数」という物です。(詳しくはググってね)\r\n\r\n#### ログイン\r\n\r\n- 環境変数`TOKEN`の値を引数にしてログインします。\r\n\r\n### 実行してみる\r\n\r\nここまで書けたら実際に実行してみましょう。\r\n\r\n`npm start`を実行して数秒待ってください。次のことが確認できれば成功です！\r\n\r\n- コンソールに`I'm ready!`と表示される。\r\n- Discord アプリ上で、登録した Bot がオンラインになっている。\r\n\r\n確認できたら、Ctrl+C などで Bot を止めておいてください。\r\n\r\n# スラッシュコマンド\r\n\r\nこの章では、スラッシュコマンドの実装を行います。\r\n\r\nこの記事を参考にしています: [discord.js でスラッシュコマンド（Slash commands）を使う - Qiita](https://qiita.com/gaato/items/55b32bc4777905ac162a)\r\n\r\n## 2 種類のスラッシュコマンド\r\n\r\nスラッシュコマンドには「ギルドコマンド」と「グローバルコマンド」の 2 種類があります。\r\n\r\n- ギルドコマンド: 特定のサーバーを指定して登録するコマンド。\r\n- グローバルコマンド: Bot が参加している全てのサーバーに登録されるコマンド。\r\n\r\nグローバルコマンドは、登録後実際に使えるようになるまで 1 時間ほどかかるようです。このため、本チュートリアルではギルドコマンドを使用します。\r\n\r\n## 環境変数の設定\r\n\r\nギルドコマンドを登録するためには、対象サーバーの ID が必要です。`.env`に保存しておきます。\r\n\r\nサーバー ID は次の方法で取得することができます。\r\n\r\n1. Discord アプリの設定画面を開き、「詳細設定」の「開発者モード」をオンにしておきます。\r\n\r\n\u003cImage alt={''} src='/works/discord-tutorial/devmode.png' /\u003e\r\n\r\n1. サーバーアイコン上で右クリックして、「ID をコピー」を選択します。サーバー ID がクリップボードにコピーされます。\r\n\r\n\u003cImage alt={''} src='/works/discord-tutorial/copy_server_id.png' /\u003e\r\n\r\n`.env`に次の項目を追記してください。`\u003cサーバーID\u003e`は実際の値に置き換えてください。\r\n\r\n```\r\nSERVER_ID=\u003cサーバーID\u003e\r\n```\r\n\r\n## シンプルなコマンド\r\n\r\nまず、`pong`というメッセージを送信するだけのシンプルなコマンド`/ping`を作成してみます。\r\n\r\n### 環境変数の型定義を記述する\r\n\r\n環境変数の型定義ファイルを作っておかないと後々面倒なので、ここで作ってしまいます。\r\n\r\n`src`に`@types`ディレクトリを作成して、中に`global.d.ts`を作り、以下の内容を入力してください。\r\n\r\n```typescript\r\ndeclare namespace NodeJS {\r\n  interface ProcessEnv {\r\n    readonly TOKEN: string\r\n    readonly SERVER_ID: string\r\n  }\r\n}\r\n```\r\n\r\n### コマンドを実装する\r\n\r\n実際にコマンドを作っていきます。次のコードを参考にして、`ready`イベントのコールバックを編集し、`interactionCreate`イベントのコールバックを追加してください。`async`キーワードが新しく加わっていることに注意してください。\r\n\r\n```typescript\r\nimport { ApplicationCommandData, Client, ClientOptions } from 'discord.js' // インポート部分が変わっています\r\n\r\n// ...\r\n\r\n// ログイン完了時に実行するコールバック関数を登録\r\nclient.once('ready', async () =\u003e {\r\n  const commands: ApplicationCommandData[] = [\r\n    {\r\n      name: 'ping',\r\n      description: 'pongと返します。',\r\n    },\r\n  ]\r\n  await client.application?.commands.set(commands, process.env.SERVER_ID)\r\n\r\n  console.log(\"I'm  ready!\")\r\n})\r\n\r\n// コマンド受信時のコールバック関数を登録\r\nclient.on('interactionCreate', async (interaction) =\u003e {\r\n  if (!interaction.isCommand()) {\r\n    return\r\n  }\r\n  if (interaction.commandName === 'ping') {\r\n    // pingコマンドが来たら:\r\n    await interaction.reply('pong') // pongとreplyする\r\n  }\r\n})\r\n```\r\n\r\n書けたら`npm start`して、アプリ上でコマンドを使えるかどうか確認してみましょう。\r\n\r\n## 引数付きコマンド\r\n\r\n引数を受け取るコマンドを作っていきます。ここでは、引数をそのまま出力する`echo`コマンドを作っていきます。\r\n\r\n### コマンドの登録\r\n\r\n次のコードを参考にして、`commands`に要素を追加してください。引数は`options`プロパティで設定します。\r\n\r\n```typescript\r\nconst commands: ApplicationCommandData[] = [\r\n  {\r\n    name: 'ping',\r\n    description: 'pongと返します。',\r\n  },\r\n  {\r\n    name: 'echo',\r\n    description: '入力された文字をそのまま返します。',\r\n    options: [\r\n      {\r\n        type: 'STRING',\r\n        name: 'value',\r\n        description: '文字列',\r\n        required: true,\r\n      },\r\n    ],\r\n  },\r\n]\r\n```\r\n\r\n### コマンドの中身を実装\r\n\r\n次のコードを参考にして、コマンドの中身を実装してください。引数は`interaction.options.getString()`などで受け取ることができます。\r\n\r\n```typescript\r\nif (interaction.commandName === 'ping') {\r\n  await interaction.reply('pong')\r\n}\r\nif (interaction.commandName === 'echo') {\r\n  const value = interaction.options.getString('value', true) // 引数valueを受け取る\r\n  await interaction.reply(value)\r\n}\r\n```\r\n\r\n書けたら`npm start`して、アプリ上でコマンドを使えるかどうか確認してみましょう。\r\n\r\n## 遅延応答\r\n\r\n「コマンドを受信したら、データベースにアクセスして処理をした後に返信したい」といったケースなど、時間のかかる処理を実装したくなることがあると思います。このような処理をそのまま書いたらどうなるでしょうか？\r\n\r\n`ping`コマンドを次のように編集してみます。ここでは 4000 ミリ秒後に\"pong\"と返信するコードを書いています。\r\n\r\n```typescript\r\nif (interaction.commandName === 'ping') {\r\n  setTimeout(async () =\u003e {\r\n    await interaction.reply('pong')\r\n  }, 4000) // 4000ミリ秒後に\"pong\"と返信\r\n}\r\n```\r\n\r\n`ping`コマンドを実際に実行してみましょう。すると、`アプリケーションが応答しませんでした`などのメッセージが表示されると思います。\r\n\r\n実は、スラッシュコマンドは**3 秒以内に返信しないとエラー**になります。\r\n\r\nこれを回避するため、`deferReply()`, `followUp()`という関数を使います。\r\n\r\n```typescript\r\nif (interaction.commandName === 'ping') {\r\n  await interaction.deferReply() // 追加\r\n  setTimeout(async () =\u003e {\r\n    await interaction.followUp('pong') // 変更\r\n  }, 4000) // 4000ミリ秒後に\"pong\"と返信\r\n}\r\n```\r\n\r\nこのコードにした上で`ping`コマンドを実行すると、`\u003cbot名\u003eが考え中…`というメッセージが表示された 4 秒後に`pong`と表示されるはずです。意図通りの挙動になりました。\r\n\r\nということで、時間のかかる処理を行う時には、返信を遅延させるために`deferReply()`や`followUp()`を使う必要があります。\r\n\r\n詳しくはこのページが参考になります: [reply と deferReply の違い - Discord.js Japan User Group](https://scrapbox.io/discordjs-japan/reply%E3%81%A8deferReply%E3%81%AE%E9%81%95%E3%81%84)\r\n\r\n# 分からないことがあったら\r\n\r\n分からないことがある時は次のサイトが頼りになります。\r\n\r\n- [Discord.js Guide](https://discordjs.guide/#before-you-begin)\r\n- [discord.js Documentation](https://discord.js.org/#/docs/discord.js/stable/general/welcome)\r\n- [Discord.js Japan User Group (Scrapbox)](https://scrapbox.io/discordjs-japan/)\r\n- 日本語 Wiki。やりたいことをここで検索すれば大体出てくる説があります。\r\n\r\n# おわり\r\n\r\nスラッシュコマンドに対応した Discord Bot を作りました。後はいろいろ工夫して頑張ってください(雑)。\r\n"}]},"__N_SSG":true},"page":"/works","query":{},"buildId":"ncCN_pq-iEY_H9wmG8Ec0","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>